---
sidebar_position: 7
---

# Reservations (Reservas de Stock)

Sistema simplificado para reservar y liberar stock con validaciÃ³n automÃ¡tica y respeto a configuraciÃ³n de locaciones.

## ğŸ¯ Problema que Resuelve

Reservar stock de forma segura combinando informaciÃ³n de:
- **Stock actual** (cantidad disponible/reservada)
- **ConfiguraciÃ³n de locaciÃ³n** (lÃ­mites, stock negativo permitido)
- **CatÃ¡logo** (verificar que item existe)
- **UbicaciÃ³n** (verificar que locaciÃ³n existe)

Todo en **3 endpoints simples** sin romper la modularidad.

---

## ğŸ“¦ Endpoints

### 1. Validar Reserva

**Valida sin modificar estado**. Ãšsalo para mostrar disponibilidad antes de confirmar.

```http
POST /api/v1/stock/reservations/validate
Content-Type: application/json

{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 30
}
```

#### Response 200 OK (Puede reservar)

```json
{
  "can_reserve": true,
  "available_quantity": 80,
  "reserved_quantity": 20,
  "total_quantity": 100,
  "max_reservation_allowed": 80,
  "errors": [],
  "warnings": [],
  "item_info": {
    "id": "ITEM-001",
    "name": "Producto XYZ",
    "sku": "SKU-001"
  },
  "location_info": {
    "id": "WAREHOUSE-MAIN",
    "name": "AlmacÃ©n Principal"
  }
}
```

#### Response 422 (No puede reservar)

```json
{
  "can_reserve": false,
  "available_quantity": 10,
  "reserved_quantity": 20,
  "total_quantity": 30,
  "errors": [
    "Stock disponible insuficiente. Disponible: 10, solicitado: 30"
  ],
  "item_info": {...},
  "location_info": {...}
}
```

---

### 2. Crear Reserva

**Crea la reserva** (modifica estado).

```http
POST /api/v1/stock/reservations/reserve
Content-Type: application/json

{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 30,
  "reference_type": "sales_order",
  "reference_id": "SO-2024-001",
  "reason": "Reserva para orden de venta",
  "performed_by": "user@example.com",
  "skip_validation": false
}
```

#### Response 201 Created

```json
{
  "success": true,
  "reservation_id": "mov-abc-123",
  "new_reserved_quantity": 50,
  "new_available_quantity": 50,
  "errors": [],
  "movement": {
    "id": "mov-abc-123",
    "type": "reserve",
    "status": "completed",
    "created_at": "2024-12-08T10:30:00Z"
  }
}
```

---

### 3. Liberar Reserva

**Libera una reserva** existente.

```http
POST /api/v1/stock/reservations/release
Content-Type: application/json

{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 30,
  "reference_id": "SO-2024-001",
  "reason": "Orden cancelada"
}
```

#### Response 200 OK

```json
{
  "success": true,
  "new_reserved_quantity": 20,
  "new_available_quantity": 80,
  "errors": []
}
```

---

## âœ… Validaciones AutomÃ¡ticas

### En `/validate` y `/reserve`

1. âœ… Item existe en catÃ¡logo
2. âœ… LocaciÃ³n existe
3. âœ… Hay stock en la locaciÃ³n
4. âœ… Stock disponible >= cantidad solicitada
5. âœ… No excede `max_reservation_percentage` (si configurado)
6. âœ… Lote no vencido (si se especifica `lot_id`)

### En `/release`

1. âœ… Existe stock en la locaciÃ³n
2. âœ… Cantidad reservada >= cantidad a liberar

---

## ğŸ”§ ConfiguraciÃ³n de LocaciÃ³n

La validaciÃ³n respeta automÃ¡ticamente la configuraciÃ³n:

```json
{
  "location_id": "WAREHOUSE-MAIN",
  "allow_negative_stock": false,
  "max_reservation_percentage": 80
}
```

### `max_reservation_percentage`

Limita cuÃ¡nto del stock total puede estar reservado.

**Ejemplo**: Con `max_reservation_percentage: 80`:
- Stock total: 100 unidades
- MÃ¡ximo reservable: 80 unidades
- Si ya hay 60 reservadas, solo puedes reservar 20 mÃ¡s

### `allow_negative_stock`

Si es `true`, permite reservar mÃ¡s de lo disponible (genera warning pero no error).

---

## ğŸ’¡ Flujos de Uso

### Flujo Completo (Recomendado)

```javascript
// 1. Validar antes de mostrar botÃ³n
const validation = await fetch('/api/v1/stock/reservations/validate', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    item_id: 'ITEM-001',
    location_id: 'WAREHOUSE-MAIN',
    quantity: 30
  })
}).then(r => r.json());

if (validation.can_reserve) {
  // 2. Mostrar UI con informaciÃ³n
  showReserveButton({
    available: validation.available_quantity,
    maxAllowed: validation.max_reservation_allowed,
    warnings: validation.warnings
  });
  
  // 3. Al confirmar usuario, crear reserva
  const reservation = await fetch('/api/v1/stock/reservations/reserve', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      item_id: 'ITEM-001',
      location_id: 'WAREHOUSE-MAIN',
      quantity: 30,
      reference_id: orderId
    })
  }).then(r => r.json());
  
  if (reservation.success) {
    alert('Reservado: ' + reservation.reservation_id);
  }
} else {
  showErrors(validation.errors);
}
```

### Flujo RÃ¡pido (API to API)

```javascript
// Skipear validaciÃ³n si ya validaste
const reservation = await fetch('/api/v1/stock/reservations/reserve', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    item_id: 'ITEM-001',
    location_id: 'WAREHOUSE-MAIN',
    quantity: 30,
    skip_validation: true  // âš ï¸ Solo si confiÃ¡s en los datos
  })
}).then(r => r.json());
```

---

## ğŸ—ï¸ Arquitectura

### SeparaciÃ³n de Responsabilidades

| Componente | Responsabilidad |
|------------|-----------------|
| **ReservationController** | HTTP request/response |
| **ValidateReservationUseCase** | Orquesta validaciones (Stock + Catalog + Locations) |
| **CreateReservationUseCase** | Crea Movement de tipo RESERVE |
| **ReleaseReservationUseCase** | Crea Movement de tipo RELEASE |
| **StockMovementService** | Procesa movements (Domain) |

### Modularidad Preservada

Los **Use Cases** orquestan sin acoplar:

```php
class ValidateReservationUseCase
{
    public function __construct(
        private StockItemRepositoryInterface $stockRepository,
        private LocationStockSettingsRepositoryInterface $settingsRepository,
        private CatalogGatewayInterface $catalogGateway,      // â† Gateway a Catalog
        private LocationGatewayInterface $locationGateway     // â† Gateway a Locations
    ) {}
}
```

âœ… **Stock** NO conoce **Catalog** ni **Locations** directamente  
âœ… Usa **Gateways** (interfaces) para acceder  
âœ… Cada mÃ³dulo sigue independiente

---

## ğŸ“Š Estados del Stock

```
Total Stock: 100 unidades
â”œâ”€â”€ Reserved: 30 unidades  â† bloqueadas por reservas
â””â”€â”€ Available: 70 unidades â† disponibles para reservar/enviar

Available = Total - Reserved
```

### Ejemplo de Flujo

```
Estado inicial:
Total: 100, Reserved: 20, Available: 80

1. Reserve 30 unidades:
   Total: 100, Reserved: 50, Available: 50

2. Shipment 10 unidades (usa de available):
   Total: 90, Reserved: 50, Available: 40

3. Release 20 unidades:
   Total: 90, Reserved: 30, Available: 60
```

---

## ğŸ” Diferencia con `/movements`

### `/movements/reserve` (Bajo nivel)

- Crea Movement directamente
- NO valida catÃ¡logo ni locaciÃ³n
- NO respeta lÃ­mites de reserva
- Para integraciones avanzadas

### `/reservations/reserve` (Alto nivel)

- âœ… Valida TODO automÃ¡ticamente
- âœ… Respeta configuraciÃ³n
- âœ… Incluye info de catÃ¡logo + locaciÃ³n
- âœ… Para aplicaciones finales

---

## ğŸš¨ Casos Especiales

### Stock Negativo Permitido

Si `allow_negative_stock: true`:

```json
// Validation response
{
  "can_reserve": true,
  "available_quantity": 10,
  "warnings": [
    "La reserva dejarÃ¡ stock disponible negativo (10 - 30 = -20)"
  ]
}
```

### Excede LÃ­mite de Reserva

Con `max_reservation_percentage: 80`:

```json
// Error response
{
  "can_reserve": false,
  "errors": [
    "Excede el lÃ­mite de reserva (80% del stock total). MÃ¡ximo permitido: 80, se alcanzarÃ­a: 90"
  ]
}
```

---

## ğŸ§ª Testing

Ver `app/Stock/Tests/Feature/ReservationFlowTest.php` para ejemplos completos.

---

## ğŸ“ Resumen

| Endpoint | AcciÃ³n | Modifica Estado |
|----------|--------|-----------------|
| `/validate` | Valida si puede reservar | âŒ NO |
| `/reserve` | Crea reserva | âœ… SÃ |
| `/release` | Libera reserva | âœ… SÃ |

**Ventajas**:
- âœ… API simple (3 endpoints)
- âœ… ValidaciÃ³n automÃ¡tica completa
- âœ… Respeta configuraciÃ³n de locaciÃ³n
- âœ… Combina Stock + Catalog + Locations
- âœ… Modularidad preservada
- âœ… InformaciÃ³n rica en respuestas
